const APP={bills:[],history:[],healthScore:750,scoreHistory:[],currentFilter:'all',creditAge:0,totalAccounts:1,init(){this.requestNotificationPermission();const setup=localStorage.getItem('setupComplete');if(!setup){this.showSetup()}else{this.loadData();this.setupEventListeners();this.updateDashboard();this.checkNotifications();setInterval(()=>this.checkNotifications(),60000);this.renderScoreChart()}},requestNotificationPermission(){if('Notification'in window&&Notification.permission==='default'){Notification.requestPermission().then(permission=>{if(permission==='granted'){console.log('Notifications enabled')}})}},showSetup(){const modal=document.createElement('div');modal.className='modal active';modal.innerHTML=`<div class="modal-content"><h3>Welcome to BillGuard!</h3><p>Enter your starting credit score (300-850):</p><input type="number" id="initialScore" min="300" max="850" value="750" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-size:18px;margin-bottom:20px"><button class="btn btn-primary" onclick="APP.completeSetup()">Start Tracking</button></div>`;document.body.appendChild(modal)},completeSetup(){const score=parseInt(document.getElementById('initialScore').value);if(score<300||score>850){alert('Please enter a score between 300 and 850');return}this.healthScore=score;this.scoreHistory=[{date:new Date().toISOString(),score:score}];localStorage.setItem('setupComplete','true');localStorage.setItem('healthScore',score);localStorage.setItem('scoreHistory',JSON.stringify(this.scoreHistory));document.querySelector('.modal').remove();this.init()},loadData(){this.bills=JSON.parse(localStorage.getItem('bills')||'[]');this.history=JSON.parse(localStorage.getItem('history')||'[]');this.healthScore=parseInt(localStorage.getItem('healthScore')||'750');this.scoreHistory=JSON.parse(localStorage.getItem('scoreHistory')||'[]');this.creditAge=parseInt(localStorage.getItem('creditAge')||'0');if(this.bills.length===0&&this.history.length===0){this.restoreFromBackup()}if(this.scoreHistory.length===0){this.scoreHistory.push({date:new Date().toISOString(),score:this.healthScore})}},saveData(){localStorage.setItem('bills',JSON.stringify(this.bills));localStorage.setItem('history',JSON.stringify(this.history));localStorage.setItem('healthScore',this.healthScore);localStorage.setItem('scoreHistory',JSON.stringify(this.scoreHistory));localStorage.setItem('creditAge',this.creditAge);this.syncToServer()},syncToServer(){const data={bills:this.bills,history:this.history,healthScore:this.healthScore,scoreHistory:this.scoreHistory,creditAge:this.creditAge,lastSync:new Date().toISOString()};const blob=new Blob([JSON.stringify(data)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`billguard-backup-${Date.now()}.json`;localStorage.setItem('billguard_backup',JSON.stringify(data))},restoreFromBackup(){const backup=localStorage.getItem('billguard_backup');if(backup){const data=JSON.parse(backup);this.bills=data.bills||[];this.history=data.history||[];this.healthScore=data.healthScore||750;this.scoreHistory=data.scoreHistory||[];this.creditAge=data.creditAge||0;this.saveData()}},setupEventListeners(){document.querySelectorAll('.nav-btn').forEach(btn=>{btn.addEventListener('click',e=>{const view=e.currentTarget.dataset.view;this.switchView(view)})});document.querySelectorAll('input[name="billType"]').forEach(radio=>{radio.addEventListener('change',e=>{document.getElementById('recurringOptions').style.display=e.target.value==='recurring'?'block':'none'})});document.getElementById('addBillForm').addEventListener('submit',e=>{e.preventDefault();this.addBill()});document.querySelectorAll('.filter-btn').forEach(btn=>{btn.addEventListener('click',e=>{document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));e.target.classList.add('active');this.currentFilter=e.target.dataset.filter;this.renderBills()})})},switchView(view){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));document.getElementById(view).classList.add('active');document.querySelector(`[data-view="${view}"]`).classList.add('active');if(view==='dashboard')this.updateDashboard();if(view==='bills')this.renderBills();if(view==='history')this.renderHistory()},addBill(){const bill={id:Date.now(),title:document.getElementById('billTitle').value,amount:parseFloat(document.getElementById('billAmount').value),dueDate:new Date(document.getElementById('billDueDate').value).toISOString(),type:document.querySelector('input[name="billType"]:checked').value,recurrence:document.getElementById('recurrence').value,affectsScore:document.getElementById('affectsScore').checked,status:'pending',createdAt:new Date().toISOString()};this.bills.push(bill);this.saveData();this.syncToServer();document.getElementById('addBillForm').reset();alert('âœ… Bill added successfully!');this.switchView('bills')},editBill(id){const bill=this.bills.find(b=>b.id===id);if(!bill)return;const modal=document.createElement('div');modal.className='modal active';modal.innerHTML=`<div class="modal-content"><h3>Edit Bill</h3><div class="form-group"><label>Title</label><input type="text" id="editTitle" value="${bill.title}" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-size:16px;margin-bottom:12px"></div><div class="form-group"><label>Amount ($)</label><input type="number" id="editAmount" value="${bill.amount}" step="0.01" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-size:16px;margin-bottom:12px"></div><div class="form-group"><label>Bill Type</label><div style="display:flex;gap:12px;margin-bottom:12px"><label style="display:flex;align-items:center;gap:8px"><input type="radio" name="editBillType" value="one-time" ${bill.type==='one-time'?'checked':''}><span>One-Time</span></label><label style="display:flex;align-items:center;gap:8px"><input type="radio" name="editBillType" value="recurring" ${bill.type==='recurring'?'checked':''}><span>Recurring</span></label></div></div><div id="editRecurringOptions" style="display:${bill.type==='recurring'?'block':'none'};margin-bottom:12px"><label>Recurrence</label><select id="editRecurrence" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-size:16px"><option value="weekly" ${bill.recurrence==='weekly'?'selected':''}>Weekly</option><option value="monthly" ${bill.recurrence==='monthly'?'selected':''}>Monthly</option><option value="yearly" ${bill.recurrence==='yearly'?'selected':''}>Yearly</option></select></div><div class="modal-actions"><button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button><button class="btn btn-primary" onclick="APP.saveEdit(${id})">Save</button></div></div>`;document.body.appendChild(modal);document.querySelectorAll('input[name="editBillType"]').forEach(radio=>{radio.addEventListener('change',e=>{document.getElementById('editRecurringOptions').style.display=e.target.value==='recurring'?'block':'none'})})},saveEdit(id){const bill=this.bills.find(b=>b.id===id);const newTitle=document.getElementById('editTitle').value;const newAmount=parseFloat(document.getElementById('editAmount').value);const newType=document.querySelector('input[name="editBillType"]:checked').value;const newRecurrence=document.getElementById('editRecurrence').value;if(newTitle&&newAmount&&newAmount>0){bill.title=newTitle;bill.amount=newAmount;bill.type=newType;bill.recurrence=newRecurrence;this.saveData();this.syncToServer();this.renderBills();this.updateDashboard();document.querySelector('.modal').remove()}},markPaid(id,onTime){const bill=this.bills.find(b=>b.id===id);if(!bill)return;bill.status='paid';bill.paidAt=new Date().toISOString();bill.paidOnTime=onTime;this.history.push({id:Date.now(),billId:bill.id,title:bill.title,amount:bill.amount,dueDate:bill.dueDate,paidAt:bill.paidAt,onTime:onTime});if(bill.affectsScore){this.updateHealthScore(onTime,bill.amount)}if(bill.type==='recurring'){this.createRecurringBill(bill)}this.saveData();this.updateDashboard();this.renderBills()},markPaidOff(id){if(confirm('Mark this bill as paid off? It will stop tracking and affecting your credit.')){const bill=this.bills.find(b=>b.id===id);if(!bill)return;bill.status='paid-off';bill.paidOffAt=new Date().toISOString();if(bill.affectsScore){this.updateHealthScore(true,bill.amount,true)}this.saveData();this.updateDashboard();this.renderBills()}},createRecurringBill(originalBill){const dueDate=new Date(originalBill.dueDate);if(originalBill.recurrence==='weekly'){dueDate.setDate(dueDate.getDate()+7)}else if(originalBill.recurrence==='monthly'){dueDate.setMonth(dueDate.getMonth()+1)}else if(originalBill.recurrence==='yearly'){dueDate.setFullYear(dueDate.getFullYear()+1)}const newBill={...originalBill,id:Date.now(),dueDate:dueDate.toISOString(),status:'pending',paidAt:null,paidOnTime:null,createdAt:new Date().toISOString()};this.bills.push(newBill)},deleteBill(id){if(confirm('Delete this bill?')){this.bills=this.bills.filter(b=>b.id!==id);this.saveData();this.renderBills();this.updateDashboard()}},updateHealthScore(onTime,amount,paidOff=false){const totalHistory=this.history.length;const onTimePayments=this.history.filter(h=>h.onTime).length;const latePayments=this.history.filter(h=>!h.onTime).length;const paymentHistoryRatio=totalHistory>0?onTimePayments/totalHistory:1;const totalBillsAmount=this.bills.reduce((sum,b)=>sum+b.amount,0);const utilizationRatio=totalBillsAmount>0?Math.min(amount/totalBillsAmount,1):0.3;this.creditAge++;const accountAgeYears=this.creditAge/12;const paymentHistoryScore=paymentHistoryRatio*35*10;const amountsOwedScore=(1-utilizationRatio)*30*10;const creditHistoryScore=Math.min(accountAgeYears*2,15)*10;const creditMixScore=5*10;const newCreditScore=2*10;let totalScore=paymentHistoryScore+amountsOwedScore+creditHistoryScore+creditMixScore+newCreditScore;if(paidOff){totalScore+=50}else if(onTime){totalScore+=20}else{totalScore-=100}const normalizedScore=300+Math.min(Math.max(totalScore/10,0),550);this.healthScore=Math.round(Math.min(850,Math.max(300,normalizedScore)));this.scoreHistory.push({date:new Date().toISOString(),score:this.healthScore});if(this.scoreHistory.length>30){this.scoreHistory.shift()}document.getElementById('healthScore').textContent=this.healthScore;this.renderScoreChart()},updateDashboard(){const now=new Date();const pending=this.bills.filter(b=>b.status==='pending');const dueSoon=pending.filter(b=>{const due=new Date(b.dueDate);const diff=due-now;return diff>0&&diff<7*24*60*60*1000});const paidOnTime=this.history.filter(h=>h.onTime).length;const delayed=this.history.filter(h=>!h.onTime).length;document.getElementById('totalBills').textContent=this.bills.length;document.getElementById('dueSoon').textContent=dueSoon.length;document.getElementById('paidOnTime').textContent=paidOnTime;document.getElementById('delayed').textContent=delayed;document.getElementById('healthScore').textContent=this.healthScore;this.renderUpcomingBills()},renderUpcomingBills(){const container=document.getElementById('upcomingBills');const now=new Date();const upcoming=this.bills.filter(b=>b.status==='pending').sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate)).slice(0,5);if(upcoming.length===0){container.innerHTML='<p style="color:var(--text-light)">No upcoming bills</p>';return}container.innerHTML=upcoming.map(bill=>{const dueDate=new Date(bill.dueDate);const isOverdue=dueDate<now;const timeLeft=this.getTimeLeft(dueDate);return`<div class="bill-item ${isOverdue?'overdue':''}"><div class="bill-header"><div><div class="bill-title">${bill.title}</div>${bill.type==='recurring'?'<span class="badge recurring">Recurring</span>':''}</div><div class="bill-amount">$${bill.amount.toFixed(2)}</div></div><div class="bill-meta"><span>ğŸ“… ${timeLeft}</span>${bill.affectsScore?'<span>ğŸ’š Affects Score</span>':''}</div><div class="bill-actions"><button class="btn btn-success" onclick="APP.markPaid(${bill.id},true)">âœ“ Paid</button><button class="btn btn-warning" onclick="APP.markPaid(${bill.id},false)">â° Late</button><button class="btn btn-secondary" onclick="APP.editBill(${bill.id})" style="flex:0;padding:10px">âœï¸</button><button class="btn btn-danger" onclick="APP.deleteBill(${bill.id})" style="flex:0;padding:10px">ğŸ—‘</button></div></div>`}).join('')},renderBills(){const container=document.getElementById('billsList');let filtered=this.bills;if(this.currentFilter==='pending'){filtered=this.bills.filter(b=>b.status==='pending')}else if(this.currentFilter==='paid'){filtered=this.bills.filter(b=>b.status==='paid'||b.status==='paid-off')}else if(this.currentFilter==='overdue'){const now=new Date();filtered=this.bills.filter(b=>b.status==='pending'&&new Date(b.dueDate)<now)}if(filtered.length===0){container.innerHTML='<p style="color:var(--text-light)">No bills found</p>';return}container.innerHTML=filtered.map(bill=>{const dueDate=new Date(bill.dueDate);const isOverdue=dueDate<new Date()&&bill.status==='pending';const timeLeft=this.getTimeLeft(dueDate);const isPaidOff=bill.status==='paid-off';return`<div class="bill-item ${isOverdue?'overdue':''} ${bill.status==='paid'||isPaidOff?'paid':''}"><div class="bill-header"><div><div class="bill-title">${bill.title}</div>${bill.type==='recurring'?'<span class="badge recurring">Recurring</span>':''}${isPaidOff?'<span class="badge" style="background:#10b981">Paid Off</span>':''}</div><div class="bill-amount">$${bill.amount.toFixed(2)}</div></div><div class="bill-meta"><span>ğŸ“… ${isPaidOff?'Paid Off':bill.status==='paid'?'Paid':timeLeft}</span>${bill.affectsScore?'<span>ğŸ’š Affects Score</span>':''}</div><div class="bill-actions">${bill.status==='pending'?`<button class="btn btn-success" onclick="APP.markPaid(${bill.id},true)">âœ“ Paid</button><button class="btn btn-warning" onclick="APP.markPaid(${bill.id},false)">â° Late</button><button class="btn" style="background:#10b981;color:white" onclick="APP.markPaidOff(${bill.id})">ğŸ’š Paid Off</button><button class="btn btn-secondary" onclick="APP.editBill(${bill.id})" style="flex:0;padding:10px">âœï¸</button>`:''}<button class="btn btn-danger" onclick="APP.deleteBill(${bill.id})" style="flex:0;padding:10px">ğŸ—‘</button></div></div>`}).join('')},renderHistory(){const container=document.getElementById('paymentHistory');if(this.history.length===0){container.innerHTML='<p style="color:var(--text-light)">No payment history yet</p>';return}const sorted=[...this.history].sort((a,b)=>new Date(b.paidAt)-new Date(a.paidAt));container.innerHTML=sorted.map(item=>`<div class="history-item"><div class="history-info"><h4>${item.title}</h4><p>$${item.amount.toFixed(2)} â€¢ ${new Date(item.paidAt).toLocaleDateString()}</p></div><span class="history-badge ${item.onTime?'on-time':'late'}">${item.onTime?'âœ“ On Time':'â° Late'}</span></div>`).join('');this.renderScoreChart()},renderScoreChart(){const canvas=document.getElementById('scoreChart');const ctx=canvas.getContext('2d');const width=canvas.width=canvas.offsetWidth;const height=canvas.height=200;ctx.clearRect(0,0,width,height);if(this.scoreHistory.length<2)return;const padding=40;const chartWidth=width-padding*2;const chartHeight=height-padding*2;const minScore=300;const maxScore=850;const scoreRange=maxScore-minScore;ctx.strokeStyle='#14b8a6';ctx.lineWidth=3;ctx.beginPath();this.scoreHistory.forEach((point,i)=>{const x=padding+(i/(this.scoreHistory.length-1))*chartWidth;const y=height-padding-((point.score-minScore)/scoreRange)*chartHeight;if(i===0){ctx.moveTo(x,y)}else{ctx.lineTo(x,y)}});ctx.stroke();ctx.fillStyle='#14b8a6';this.scoreHistory.forEach((point,i)=>{const x=padding+(i/(this.scoreHistory.length-1))*chartWidth;const y=height-padding-((point.score-minScore)/scoreRange)*chartHeight;ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fill()});ctx.strokeStyle='#e2e8f0';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(padding,padding);ctx.lineTo(padding,height-padding);ctx.lineTo(width-padding,height-padding);ctx.stroke();ctx.fillStyle='#64748b';ctx.font='12px sans-serif';ctx.fillText(maxScore,5,padding);ctx.fillText(minScore,5,height-padding)},getTimeLeft(dueDate){const now=new Date();const diff=dueDate-now;if(diff<0){return'Overdue'}const days=Math.floor(diff/(1000*60*60*24));const hours=Math.floor((diff%(1000*60*60*24))/(1000*60*60));if(days>0){return`${days}d ${hours}h`}else if(hours>0){return`${hours}h`}else{return'Due soon'}},checkNotifications(){const now=new Date();this.bills.filter(b=>b.status==='pending').forEach(bill=>{const dueDate=new Date(bill.dueDate);const diff=dueDate-now;const hours24=24*60*60*1000;if(diff>0&&diff<=hours24){const notified=localStorage.getItem(`notified_${bill.id}`);if(!notified){this.showNotification(bill);this.playAlarmWithVibration();localStorage.setItem(`notified_${bill.id}`,'true')}}})},playAlarmWithVibration(){if('vibrate'in navigator){navigator.vibrate([200,100,200,100,200])}const audioContext=new(window.AudioContext||window.webkitAudioContext)();const playBeep=(freq,delay)=>{setTimeout(()=>{const osc=audioContext.createOscillator();const gain=audioContext.createGain();osc.connect(gain);gain.connect(audioContext.destination);osc.frequency.value=freq;osc.type='sine';gain.gain.setValueAtTime(0.5,audioContext.currentTime);osc.start(audioContext.currentTime);osc.stop(audioContext.currentTime+0.2)},delay)};playBeep(800,0);playBeep(1000,300);playBeep(800,600)},showNotification(bill){const modal=document.getElementById('notificationModal');const text=document.getElementById('notificationText');const hours=Math.floor((new Date(bill.dueDate)-new Date())/(1000*60*60));text.textContent=`${bill.title} is due in ${hours} hours! Amount: $${bill.amount.toFixed(2)}`;modal.classList.add('active');if('Notification'in window&&Notification.permission==='granted'){new Notification('ğŸ”” BillGuard Reminder',{body:text.textContent,icon:'icon-192.png',badge:'icon-192.png',vibrate:[200,100,200],requireInteraction:true,tag:`bill-${bill.id}`})}}};function closeNotification(){document.getElementById('notificationModal').classList.remove('active')}if('serviceWorker'in navigator){navigator.serviceWorker.register('sw.js').then(reg=>{reg.addEventListener('updatefound',()=>{const newWorker=reg.installing;newWorker.addEventListener('statechange',()=>{if(newWorker.state==='activated'&&navigator.serviceWorker.controller){const updateBanner=document.createElement('div');updateBanner.style.cssText='position:fixed;top:0;left:0;right:0;background:#14b8a6;color:white;padding:16px;text-align:center;z-index:9999;box-shadow:0 2px 8px rgba(0,0,0,0.2)';updateBanner.innerHTML='<strong>New version available!</strong> <button onclick="location.reload()" style="margin-left:12px;padding:8px 16px;background:white;color:#14b8a6;border:none;border-radius:6px;font-weight:bold;cursor:pointer">Update Now</button>';document.body.prepend(updateBanner)}})})});let refreshing;navigator.serviceWorker.addEventListener('controllerchange',()=>{if(refreshing)return;refreshing=true;window.location.reload()})}document.addEventListener('DOMContentLoaded',()=>APP.init());
